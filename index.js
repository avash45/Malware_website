const express = require("express")    //variable
const bodyParser = require("body-parser")   //variable
const path = require('path')
const mysql= require('mysql')

const app = express()    //object created

// Creating a connection to the database
const db = mysql.createConnection({
    host: 'localhost',
    user: 'root',    
    database: 'malware_website'
})
db.connect ((err) =>{
    if(err){
        throw err;
    }
    console.log('SQL Connected')
});

app.use(express.static(path.join(__dirname, '/views')))
app.use(bodyParser.urlencoded({extended:true}))
app.set('view engine','ejs')


app.get("/",function(req, res){
    res.render("html/homepage.ejs");
})

app.get("/login" ,function(req, res){
    res.render("html/login.ejs");
});


app.post("/login",function(req,res){
    var email = req.body.email
    var password =req.body.password
    let sql = "SELECT * FROM USERINFO WHERE email='"+email+"' AND password='"+password+"';";
    db.query(sql , (err, result)=>{
        if(err) throw err;
        if(result==null){
            console.log("No accounts found");
            alert("No account found. Create an account to login");
        }
        else{
            res.render('html/softwares/windows_downloads.ejs')
        }
    });
});

app.get("/register" ,function(req, res){
    res.render("html/register.ejs");
});


app.post("/register",function(req,res){
    var email = req.body.email
    var password =req.body.password
    console.log(email+" "+password)
    let sql = "SELECT * FROM USERINFO WHERE email='"+email+"' AND password='"+password+"';";
    db.query(sql , (err, result)=>{
        if(err) throw err;
        if(result==null){
            let sql= "INSERT INTO USERINFO VALUES('"+email+"' , '" +password+ "');" 
            db.query(sql ,(err, result)=>{
                if(err) throw err;
                console.log('Data inserted');
                console.log('Login to continue');
                res.render('html/login.ejs')
            })
        }
        else{
            console.log('Account already created')
            res.render('html/login.ejs')
        }
    });
});



app.listen("3006",function(){
    console.log("Server started on port: 3006");
});
